# fastlane/Fastfile
default_platform :ios
setup_travis

platform :ios do
  before_all do
    cocoapods(repo_update: true, silent: true)
  end

  desc "Runs the tests defined for the mapswipe scheme. Used in Travis to trigger the CI step."
  lane :test do
    match(type: "development", readonly: is_ci)
    scan(scheme: "mapswipe",
         configuration: "Debug",
         clean: true,
         derived_data_path: "build",
         build_for_testing: true,
         devices:['iPhone X'])
    scan(scheme: "mapswipe",
         configuration: "Debug",
         test_without_building: true,
         derived_data_path: "build",
         devices:['iPhone X'])
  end

  desc "Build production version and upload to appstore. This step is executed when a tag on master is created"
  lane :release do
    increment_build_number(build_number: ENV['MAPSWIPE_BUILD_NUMBER'])
    increment_version_number(version_number: ENV['MAPSWIPE_PACKAGE_VERSION'])
    match(type: "appstore", readonly: is_ci)
    build_app(scheme: "mapswipe", configuration: "Release", clean: true)
    upload_to_app_store
    slack(message: "Successfully uploaded a new App Store build")
  end

  desc "Build the beta version and upload it to testflight. This step is executed when a tag on any branch is created"
  lane :beta do
    increment_build_number(build_number: ENV['MAPSWIPE_BUILD_NUMBER'])
    increment_version_number(version_number: ENV['MAPSWIPE_PACKAGE_VERSION'])
    match(type: "appstore", readonly: is_ci)
    build_app(scheme: "mapswipe", configuration: "Beta", clean: true, silent: true)
    upload_to_testflight(username: "mapswipe.dev@gmail.com")
    slack(message: "Successfully distributed a new beta build")
  end
end
